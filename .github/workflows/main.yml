name: "NewMonolithic Pipeline"
on: 
  workflow_dispatch:

jobs:
  buildstage:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@v5.0.0
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'
    - name: Install NodeJS Dependencies
      uses: luisfuentech/gha-cache-deps@v1.2.3
      with: 
        node-manager: npm
        lock-file: package-lock.json
    - name: Build React App (ignore ESLint warnings)
      run: npm run build
      env:
        CI: false
    - name: Set Artifact Name
      id: set-artifact-name
      run: echo "name=react-build" >> $GITHUB_OUTPUT

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v4.6.2
      with:
         name: react-build
         path: build/ 

  deploystage:
    needs: buildstage
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v5.0.0
        with:
          name: react-build
          path: build/

      - name: Upload build folder to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          port: 22
          source: "build/*"
          target: "/home/${{ secrets.VM_USERNAME }}/react-app"

      - name: Install serve and Restart React Static Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          port: 22
          script: |
            # Install serve if not already installed
            which serve || npm install -g serve

            # Kill previous serve process if running
            pkill -f "serve -s /home/${{ secrets.VM_USERNAME }}/react-app" || true

   
          

      
    
    
      
      
